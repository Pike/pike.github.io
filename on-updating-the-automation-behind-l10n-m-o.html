<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>On updating the automation behind l10n.m.o</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="/on-updating-the-automation-behind-l10n-m-o.html" rel="canonical" />
  <!-- Feed -->

  <link href="/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="/theme/css/code_blocks/github.css" rel="stylesheet">


  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->



    <meta name="description" content="Or, how to change everything and nobody sees a difference. Heads up: All I'm writing about here is running on non-web-facing VMs behind...">

    <meta name="author" content="Axel Hecht">

    <meta name="tags" content="buildbot">
    <meta name="tags" content="compare-locales">
    <meta name="tags" content="L10n">
    <meta name="tags" content="Mozilla">




<!-- Open Graph -->
<meta property="og:site_name" content="Axel Hecht"/>
<meta property="og:title" content="On updating the automation behind l10n.m.o"/>
<meta property="og:description" content="Or, how to change everything and nobody sees a difference. Heads up: All I'm writing about here is running on non-web-facing VMs behind..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/on-updating-the-automation-behind-l10n-m-o.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-03-03 13:01:00+00:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/axel-hecht.html">
<meta property="article:section" content="L10n, Mozilla"/>
<meta property="article:tag" content="buildbot"/>
<meta property="article:tag" content="compare-locales"/>
<meta property="article:tag" content="L10n"/>
<meta property="article:tag" content="Mozilla"/>
<meta property="og:image" content="/theme/images/post-bg.jpg">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "On updating the automation behind l10n.m.o",
  "headline": "On updating the automation behind l10n.m.o",
  "datePublished": "2017-03-03 13:01:00+00:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Axel Hecht",
    "url": "/author/axel-hecht.html"
  },
  "image": "/theme/images/post-bg.jpg",
  "url": "/on-updating-the-automation-behind-l10n-m-o.html",
  "description": "Or, how to change everything and nobody sees a difference. Heads up: All I'm writing about here is running on non-web-facing VMs behind..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>


    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" >
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">On updating the automation behind l10n.m.o</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="/author/axel-hecht.html">Axel Hecht</a>
            | <time datetime="Fri 03 March 2017">Fri 03 March 2017</time>
        </span>
        <!-- TODO : Modified check -->
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>Or, how to change everything and nobody sees a difference.</p>
<p><em>Heads up: All I'm writing about here is running on non-web-facing VMs behind VPN.</em></p>
<p><strong>tl;dr:</strong> I changed 5 VMs, landed 76 changesets in 7 repositories, <a class="reference external" href="https://bugzilla.mozilla.org/buglist.cgi?bug_id=1137667%2C1341886%2C1342649%2C1138550%2C1138553%2C1137666%2C1336138%2C1330707%2C1137668%2C1333398%2C1290906%2C1343233&amp;bug_id_type=anyexact&amp;list_id=13470378&amp;query_format=advanced#">resolving 12 bugs</a>, got <a class="reference external" href="https://github.com/issues?utf8=%E2%9C%93&amp;q=user%3Adocker+is%3Aissue+author%3APike+">two issues in docker</a> fixed, and took a couple of days of downtime. If automation is your cup of tea, I have some open questions at the end, too.</p>
<p>To set the stage: Behind the scenes of the <a class="reference external" href="https://l10n.mozilla.org/">elmo website</a>, there's a system that generates the data that it shows. That system consists of two additional VMs, which help with the automation.</p>
<p>One is nick-named <em>a10n</em>, and is responsible for polling all those mercurial repositories that we use for l10n, and to update the elmo database with information about these repositories as it comes in. elmo basically keeps a copy of the mercurial metadata for quicker access.</p>
<p>The other is running <tt class="docutils literal">buildbot</tt> to do the actual data collection jobs about the l10n status in our source repositories. This machine runs both a master and one slave (the actual workhorse, not my naming).</p>
<p>This latter machine is an old VM, on old OS, old Python (2.6), never had real IT support, and is all around historic. And needed to go.</p>
<p>With the help of IT, I had a new VM, with a new shiny python 2.7.x, and a new storage. Something that can actually run current versions of compare-locales, too. So I had to create an update for</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="2%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr><td>Python 2.6</td>
<td>→</td>
<td>Python 2.7.x</td>
</tr>
<tr><td>globally installed python modules</td>
<td>→</td>
<td>virtualenv</td>
</tr>
<tr><td>Django 1.4.18</td>
<td>→</td>
<td>Django 1.8.x</td>
</tr>
<tr><td>Ubuntu</td>
<td>→</td>
<td>CentOS</td>
</tr>
<tr><td>Mercurial 3.7.3</td>
<td>→</td>
<td>Mercurial 4.0.1 and hglib</td>
</tr>
<tr><td>individual local clones</td>
<td>→</td>
<td><a class="reference external" href="http://mozilla-version-control-tools.readthedocs.io/en/latest/hgmozilla/unifiedrepo.html">unified</a> local clones</td>
</tr>
<tr><td>No working stage</td>
<td>→</td>
<td>docker-compose up</td>
</tr>
</tbody>
</table>
<p>At the same time, we also changed hg.m.o from http to https all over the place, which also required a handful of code changes.</p>
<p>One thing that I did not change is buildbot. I'm using a heavily customized version of buildbot 0.7.12, which is incompatible with later buildbot changes. So I'm tied to my branch of 0.7.12 for now, and with that to Twisted 8.2.0. That will change, but in a different blog post.</p>
<div class="section" id="unified-repositories">
<h2>Unified Repositories</h2>
<p>One thing I wanted and needed for a long time was to use <em>unified</em> clones of our mercurial repositories. Aside from the obvious win in terms of disk usage, it allows to use mercurial directly to create a diff from a revision that's only on aurora against a revision that's only on beta. Sadly, I did think otherwise when I wrote the first parts of elmo and the automation behind it, often falling back to <tt class="docutils literal">default</tt> instead of an actual hash revision, if I didn't know anything ad-hoc. So that had to go, and required a surprising amount of changes. I also changed the way that comparisons are triggered, making them fully reproducible. They also got more robust. I used to run <tt class="docutils literal">hg id <span class="pre">-ir</span> .</tt> to get the revision, which worked OK, unless you had extension errors in stdout/stderr. Meh. Good that that's gone.</p>
<p>As I noted, the unified repositories also benefit doing diffs, which is one of the features of elmo for reviewing localizations. Now that we can just use plain mercurial to get those diffs, I could remove a bunch of code that created diffs between aurora and beta by creating diffs between each head and some ancestor, and then sticking those diffs back together. Good that that's gone.</p>
</div>
<div class="section" id="testing">
<h2>Testing</h2>
<p>Testing an automation with that many moving parts is hard. Some things can be tested via unit tests, but more often, you just need integration tests. I still have to find a way to write automated integration tests, but even manual integration tests require a ton of set-up:</p>
<ul class="simple">
<li>elmo</li>
<li>MySQL</li>
<li>ElasticSearch</li>
<li>RabbitMQ</li>
<li>Mercurial upstream repositories</li>
<li>Mercurial web server</li>
<li>a10n get-pushes poller</li>
<li>a10n data ingestion worker</li>
<li>Buildbot master</li>
<li>Buildbot slave</li>
</ul>
<p>Doing this manually is evil, and on Macs, it's not even possible, because Twisted 8.2.0 doesn't build anymore. I used to have a script that did many of these things, but that's .... you guessed it. Good that that's gone. Now I have a <tt class="docutils literal"><span class="pre">docker-compose</span></tt> <a class="reference external" href="https://github.com/Pike/test-l10n">test setup</a>, that has most things running with just a <tt class="docutils literal"><span class="pre">docker-compose</span> up</tt>. I'm still running elmo and MySQL on my host machine, fixing that is for another day. Also, I haven't found a good way to do initial project setup like database creations. Anyway, after finding a couple of bugs in docker, this system now fires up quickly and let's me do various changes and see how they pass through the system. One particularly nice artifact is that the output of docker-compose is actually all the logs together in one stream. So as you're pushing things through the system, you just have one log to watch.</p>
<p>As part of this work, I also greatly simplified the code structure, and moved the buildbot integration from three repositories into one. Good that those are gone.</p>
</div>
<div class="section" id="snafus">
<h2>snafus</h2>
<p>Sadly there were a few bits and pieces where my local testing didn't help:</p>
<p>Changing the URL schemes for hg.m.o to https alongside this change triggered a couple of problems where Twisted 8.2 and modern Python/OpenSSL can't get a connection up. Had to replace the requests to websites with synchronous <tt class="docutils literal">urllib2.urlopen</tt> calls.</p>
<p>Installing mercurial in a virtualenv to be used via hglib is good, but WSGI doesn't activate the virtualenv, and thus <tt class="docutils literal">PATH</tt> isn't set. My <a class="reference external" href="https://github.com/mozilla/elmo/commit/737a1328285a89d595bfabb29b2b900762fbdb37">fix</a> still needs <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1343898">some server-side changes</a> to work.</p>
<p>I didn't have enough local testing for the things that Thunderbird needs. That left that setup burning for longer than I anticipated. The fix wasn't hard, just badly timed.</p>
<p>Every now and then, Django 1.8.x and MySQL decide that it's a good idea to throw away the connection, and die badly. In the case of long-running automation jobs, that's really hard to prevent, in particular because I still haven't fully understood what change actually made that happen, and what the right fix is. I just plaster <tt class="docutils literal">connection.close()</tt> into every other function, and see if it stops dying.</p>
<p>On Saturday morning I woke up, and the automation didn't process Firefox for a locale on aurora. I freaked out, and added tons of logging. Good logging that is. Best logging. Found a different bug. Also found out that the locale was Belarus, and that wasn't part of the build on Saturday. Hit my head against a wall or two.</p>
<p>Said logging made uncaught exceptions in some parts of the code actually show up in logs, and discovered that I hadn't tested my work against bad configurations. And we have that, Thunderbird just builds everything on central, regardless of whether the repositories it should use for that exist or not. I'm not really happy yet with the way I fixed this.</p>
</div>
<div class="section" id="open-questions">
<h2>Open Questions</h2>
<ul class="simple">
<li>Anyone got taskcluster running on something resembling docker-compose for local testing and development? You know, to get off of buildbot.</li>
<li>Initial setup steps for the docker-compose staging environment are best done ... ?</li>
<li>Test https connections in docker-compose? Can I? Which error cases would that cover?</li>
</ul>
</div>

            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=On updating the automation behind l10n.m.o&amp;url=/on-updating-the-automation-behind-l10n-m-o.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=/on-updating-the-automation-behind-l10n-m-o.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=/on-updating-the-automation-behind-l10n-m-o.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="/tag/buildbot.html">buildbot</a><a href="/tag/compare-locales.html">compare-locales</a><a href="/tag/l10n.html">L10n</a><a href="/tag/mozilla.html">Mozilla</a>                </aside>

                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script type="text/javascript" src="/theme/js/script.js"></script>

</body>
</html>