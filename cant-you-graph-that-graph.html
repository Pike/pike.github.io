<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>Can't you graph that graph</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="/cant-you-graph-that-graph.html" rel="canonical" />
  <!-- Feed -->

  <link href="/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="/theme/css/code_blocks/github.css" rel="stylesheet">


  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->



    <meta name="description" content="I'm going to just recreate blame, he said. It's going to be easy, he said. We have a project to migrate the localization of Firefox to...">

    <meta name="author" content="Axel Hecht">

    <meta name="tags" content="L10n">
    <meta name="tags" content="mercurial">
    <meta name="tags" content="Mozilla">




<!-- Open Graph -->
<meta property="og:site_name" content="Axel Hecht"/>
<meta property="og:title" content="Can't you graph that graph"/>
<meta property="og:description" content="I'm going to just recreate blame, he said. It's going to be easy, he said. We have a project to migrate the localization of Firefox to..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/cant-you-graph-that-graph.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-03-23 07:01:00+00:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/axel-hecht.html">
<meta property="article:section" content="L10n, Mozilla"/>
<meta property="article:tag" content="L10n"/>
<meta property="article:tag" content="mercurial"/>
<meta property="article:tag" content="Mozilla"/>
<meta property="og:image" content="/theme/images/post-bg.jpg">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Can't you graph that graph",
  "headline": "Can't you graph that graph",
  "datePublished": "2017-03-23 07:01:00+00:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Axel Hecht",
    "url": "/author/axel-hecht.html"
  },
  "image": "/theme/images/post-bg.jpg",
  "url": "/cant-you-graph-that-graph.html",
  "description": "I'm going to just recreate blame, he said. It's going to be easy, he said. We have a project to migrate the localization of Firefox to..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>


    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" >
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">Can't you graph that graph</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="/author/axel-hecht.html">Axel Hecht</a>
            | <time datetime="Thu 23 March 2017">Thu 23 March 2017</time>
        </span>
        <!-- TODO : Modified check -->
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>I'm going to just recreate blame, he said. It's going to be easy, he said.</p>
<p>We have a project to migrate the localization of Firefox to one repository for all channels, nick-named cross-channel, or x-channel in short. The plan is to create one repository that holds all the en-US strings we need for Firefox and friends on all channels. One repository to rule them all, if you wish. So you need to get the contents of <tt class="docutils literal"><span class="pre">mozilla-central</span></tt>, <tt class="docutils literal"><span class="pre">comm-central</span></tt>, <tt class="docutils literal"><span class="pre">*-aurora</span></tt>, <tt class="docutils literal"><span class="pre">*-beta</span></tt>, <tt class="docutils literal"><span class="pre">*-release</span></tt>, and also some of <tt class="docutils literal"><span class="pre">*-esr??</span></tt> together in one repository, with, say, one <tt class="docutils literal">toolkit/chrome/global/customizeToolbar.dtd</tt> file that has all the strings that are used by any of the apps on any branch.</p>
<p>We do have some experience with merging the content of localization files as part of l10n-merge which is run at Firefox build time. So this shouldn't be too hard, right?</p>
<p>Enter version control, and the fact that quite a few of our localizers are actually following the development of Firefox upstream, patch by patch. That they're trying to find the original bug if there's an issue or a question. So, it'd be nice to have the history and blame in the resulting repository reflect what's going on in mozilla-central and its dozen siblings.</p>
<p>Can't we just hg convert and be done with it? Sadly, that only converts one DAG into another hg DAG, and we have a dozen. We have a dozen heads, and we want a single head in the resulting repository.</p>
<p>Thus, I'm working on creating that repository. One side of the task is to update that target repository as we see updates to our 12 original heads. I'm pretty close to that one.</p>
<p>The other task is to create a good starting point. Or, good enough. Maybe if we could just create a repo that had the same blame as we have right now? Like, not the hex or integer revisions, but annotate to the right commit message etc? That's easy, right? Well, I thought it was, and now I'm learning.</p>
<p>To understand the challenges here, one needs to understand the data we're throwing at any algorithm we write, and the mercurial code that creates the actual repository.</p>
<p>As of <a class="reference external" href="https://hg.mozilla.org/mozilla-central/rev/FIREFOX_AURORA_45_BASE">FIREFOX_AURORA_45_BASE</a>, just the blame for the localized files for Firefox and Firefox for Android includes 2597 hg revisions. And that's not even getting CVS history, but just what's in our usual hg repository. Also, not including <tt class="docutils literal"><span class="pre">comm-central</span></tt> in that number. If that history was linear, things would probably be pretty easy. At least, I blame the problems I see in blame on things not being linear.</p>
<p>So, how non-linear is that history. The first attempt is to look at the revision set with <tt class="docutils literal">hg log <span class="pre">-G</span> <span class="pre">-r</span> <span class="pre">....</span></tt> . That creates a graph where the maximum number of parents of a single changeset is at 1465. Yikes. We can't replay that history in the target repository, as hg commits can only have 2 parents. Also, that's clearly not real, we've never had that many parallel threads of development. Looking at the underlying mercurial code, it's showing all reachable roots as parents of a changeset, if you have a sparse graph. That is, it gives you all possible connections through the underlying full graph to the nodes in your selection. But that's not what we're interested in. We're interested in the graph of just our nodes, going just through our nodes.</p>
<p>In a first step, I wrote code that removes all grandchildren from our parents. That reduces the maximum number of parents to 26. Much better, but still bad. At least it's at a size where I can start to use graphviz to create actual visuals to inspect and analyze. Yes, I can graph <strong>that</strong> graph.</p>
<p>The resulting graph has a few features that are actually already real. mozilla-central has multiple roots. One is the initial hg import of the Firefox code. Another is including Firefox for Android in <tt class="docutils literal"><span class="pre">mozilla-central</span></tt>, which used to be an independent repository. Yet another is the merge of <tt class="docutils literal">services/sync</tt>. And then I have two heads, which isn't much of a problem, it's just that their merge commit didn't create anything to blame for, and thus doesn't show up in my graph. Easy to get to, too.</p>
<p>Looking at a subset of the current graph, it's clear that there are more arcs to remove:</p>
<p><img alt="image0" class="aligncenter size-full wp-image-594" src="images/2017/03/arcs-to-remove.png" style="width: 487px; height: 721px;" /></p>
<p>Anytime you have an arc that just leap-frogs to an ancestor, you can safely remove that. I indicated some in the graph above, and you'll find more - I was just tired of annotating in Preview. As said before, I already did that for grandchildren. Writing this post I realize that it's probably easy enough to do it for grandgrandchildren, too. But it's also clear from the <a class="reference external" href="images/2017/03/m-c-l10n-blame-graph-almost-simple.svg">full graph</a>, that that algorithm probably won't scale up. Seems I need to find a good spot at which to write an explicit loop detection.</p>
<p>This endeavour sounds a bit academic at first, why would you care? There are two reasons:</p>
<p>Blame in mercurial depends on the diff that's stored in the backend, and the diff depends on the previous content. So replaying the blame in some way out of band doesn't actually create the same blame. My current algorithm is to just add the final lines one by one to the files, and commit. Whitespace and reoccurring lines get all confused by that algorithm, sadly.</p>
<p>Also, this isn't a one-time effort. The set of files we need to expose in the target depends on the configuration, and often we fix the configuration of Firefox l10n way after the initial landing of the files to localize. So having a sound code-base to catch up on missed history is an important step to make the update algorithm robust. Which is really important to get it run in automation.</p>
<p>PS: The tune for this post is &quot;That Smell&quot; by Lynyrd Skynyrd.</p>

            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Can't you graph that graph&amp;url=/cant-you-graph-that-graph.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=/cant-you-graph-that-graph.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=/cant-you-graph-that-graph.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="/tag/l10n.html">L10n</a><a href="/tag/mercurial.html">mercurial</a><a href="/tag/mozilla.html">Mozilla</a>                </aside>

                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script type="text/javascript" src="/theme/js/script.js"></script>

</body>
</html>